(* Type 3 Code - This code will be auto-generated by HAMR to provide interfaces for 
 *  port communication and threading that
 *   - are called by CakeML Type 4 code (application code)
 *   - call "down" via FFI to Type 3 C code - a thin bridge to HAMR C APIs that are standard to all languages and platforms
 *
 *  ToDo: This code should be placed in a separate file (separated from Type 4 application code)
 *)
 
(* This structure is populated with HAMR-generated code *)
structure API =
struct

  (* Used to make FFI calls where no response from the outside world is expected *)
  val empty_byte_array = Word8Array.array 0 (Word8.fromInt 0);
  val singleton_byte_array = Word8Array.array 1 (Word8.fromInt 0);  

  (**********************************
   * begin generic API functions    *
   **********************************)

  (* logging functions *)
  
  fun logInfo s = (#(loginfo) s empty_byte_array);
  fun logDebug s = (#(logdebug) s empty_byte_array);
  fun logError s = (#(logerror) s empty_byte_array);

  (* ToDo: Need to develop an approach for implementing the AADL Initialize Entry point *)
  fun initialise() = (#(initialise) "" empty_byte_array);

  fun wait() =
      (#(wait) "" singleton_byte_array;
       Word8Array.sub singleton_byte_array 0 <> Word8.fromInt 0);

  (**********************************
   * begin component-specific API   *
   **********************************)

  (* ToDo: Rename to set_<AADL-out-port-name> *)
  fun sb_write_port_write s = #(sb_write_port_write) s empty_byte_array; (* TODO: validate length of s *)
end;

(**********************************************************************************************************
 * Application Code (Type 4 code)
 **********************************************************************************************************)
 
(* This structure is populated with developer-written code *)
structure Client =
struct

  val value = Ref(Char.chr 0)

  fun initialise() = ();
  
  fun timeTriggered() =
      (API.sb_write_port_write(String.implode[!value]);
       API.logInfo "---------------------------------------\n";
       API.logInfo(String.concat ["[src] Sent ",Int.toString(Char.ord(!value)),"\n"]);
       value := Char.chr(Int.mod (Char.ord(!value) + 1) 128)
      );

  (* ===========================================================*
   * The methods below are not currently used in HAMR/Slang     *
   * ===========================================================*)

  fun activate() = ();

  fun deactivate() = ();

  fun finalise() = ();

  fun recover() = ();
end;

(* ToDo:  This is type 3 code and should be grouped with the other Type 3 code (separated into port APIs and control/threading *)
(* This structure is populated with HAMR-generated code *)
structure Control =
struct
  fun loop () =
      if API.wait() then
        (Client.timeTriggered();
         loop())
      else
        loop();
end;

(* Startup: client initalisation, then enter main loop *)
val _ = API.initialise();
val _ = Client.initialise();
val _ = Control.loop();
