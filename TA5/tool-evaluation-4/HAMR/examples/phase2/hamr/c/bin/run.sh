#!/usr/bin/env bash
#
# This file is autogenerated.  Do not edit
#
set -e
export SCRIPT_HOME=$( cd "$( dirname "$0" )" &> /dev/null && pwd )
cd $SCRIPT_HOME

# Uncomment the following to prevent terminal from closing when the app shuts down or crashes
#PREVENT_CLOSE="; bash -i"


OPTIONS=s:h
LONGOPTS=scheduler:,help

function usage {
  echo ""
  echo "Usage: <option>*"
  echo ""
  echo "Available Options:"
  echo "-s, --scheduler        The scheduler to use (expects one of"
  echo "                         { default, roundRobin, static, legacy};"
  echo "                         default: default)"
  echo "-h, --help             Display this information"
}

! PARSED=$(getopt --options=$OPTIONS --longoptions=$LONGOPTS --name "$0" -- "$@")
if [[ ${PIPESTATUS[0]} -ne 0 ]]; then
    usage
    exit 1
fi

eval set -- "$PARSED"

SCHEDULER="default"
while true; do
  case "$1" in
    -h|--help) usage; exit 0 ;;
    -s|--scheduler)
      case "$2" in
        default|roundRobin|static|legacy)
          SCHEDULER="$2" ;;
        *)
          echo "Invalid scheduler: ${2}"
          exit 2 ;;
      esac
      shift 2 ;;
    --) shift; break ;;
  esac
done

# handle non-option arguments
if [[ $# -ne 0 ]]; then
  echo "$0: Unexpected non-option arguments"
  usage
  exit 3
fi

function launch() {
  if [ "$2" ]; then SCHEDULER_ARG=" -s ${2}"; fi
  if [ -n "$COMSPEC" -a -x "$COMSPEC" ]; then
    for APP in $1; do
      cygstart mintty /bin/bash "slang-build/${APP}${SCHEDULER_ARG}${PREVENT_CLOSE}" &
    done
  elif [[ "$(uname)" == "Darwin" ]]; then
    for APP in $1; do
      open -a Terminal "slang-build/${APP}${SCHEDULER_ARG}${PREVENT_CLOSE}" &
    done
  elif [[ "$(expr substr $(uname -s) 1 5)" == "Linux" ]]; then
    for APP in $1; do
      x-terminal-emulator -T ${APP} -e sh -i -c "slang-build/${APP}${SCHEDULER_ARG}${PREVENT_CLOSE}" &
    done
  else
    >&2 echo "Platform not supported: $(uname)."
    exit 1
  fi
}

EXT=""
if [ -n "$COMSPEC" -a -x "$COMSPEC" ]; then EXT=".exe"; fi

case "${SCHEDULER}" in
  legacy)
    if [ ! -f ./slang-build/LegacyDemo${EXT} ]; then
      if [ -f ./slang-build/Demo${EXT} ]; then
        echo "Error: Found program for Slang based schedulers.  Pass '--legacy' to the"
        echo "transpiler script in order to use the legacy scheduler"
      else
        echo "Expected program not found, have you compiled? ${SCRIPT_HOME}/slang-build/LegacyDemo${EXT}"
      fi
      exit 1
    fi

    launch "UARTDriver_Impl_MCMP_PROC_SW_FC_UART_UARTDriver_App${EXT} RadioDriver_Attestation_thr_Impl_MCMP_PROC_SW_RADIO_RadioDriver_Attestation_App${EXT} FlyZonesDatabase_thr_Impl_MCMP_PROC_SW_FlyZones_FlyZonesDatabase_App${EXT} UxAS_thr_Impl_MCMP_PROC_SW_UXAS_UxAS_App${EXT} WaypointPlanManagerService_thr_Impl_MCMP_PROC_SW_WPM_WaypointPlanManagerService_App${EXT} CASE_AttestationGate_thr_Impl_MCMP_PROC_SW_AM_Gate_CASE_AttestationGate_App${EXT} CASE_Filter_LST_thr_Impl_MCMP_PROC_SW_FLT_LST_CASE_Filter_LST_App${EXT} CASE_Monitor_Req_thr_Impl_MCMP_PROC_SW_MON_REQ_CASE_Monitor_Req_App${EXT} CASE_Monitor_Geo_thr_Impl_MCMP_PROC_SW_MON_GEO_CASE_Monitor_Geo_App${EXT}";

    read -p "Press enter to initialise components ..."
    slang-build/LegacyDemo${EXT}
    read -p "Press enter again to start ..."
    slang-build/LegacyDemo${EXT}
    ;;
  *)
    if [ ! -f ./slang-build/Demo${EXT} ]; then
      if [ -f ./slang-build/LegacyDemo${EXT} ]; then
        echo "Error: Found program for the legacy scheduler. Either pass '-s legacy' to the"
        echo "run script if you want to use the legacy scheduler, or, do not pass"
        echo "'--legacy' to the transpiler script if you want to use a Slang based scheduler"
      else
        echo "Expected program not found, have you compiled? ${SCRIPT_HOME}/slang-build/Demo${EXT}"
      fi
      exit 1
    fi

    launch "Demo" ${SCHEDULER};
    ;;
esac
